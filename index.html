<script>
  const db = firebase.database();
  const listRef = db.ref("items");

  function addItem() {
    const input = document.getElementById("itemInput");
    const value = input.value.trim();
    if (!value) return;
    const newItemRef = listRef.push();
    newItemRef.set({
      text: value,
      checked: false,
      order: Date.now()
    });
    input.value = "";
  }

  document.getElementById("itemInput").addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      addItem();
    }
  });

  const listElement = document.getElementById("list");

  // âœ… Sortable åˆæœŸè¨­å®šï¼ˆè¦–è¦šåŠ¹æžœä»˜ãï¼‰
  const sortable = new Sortable(listElement, {
    animation: 150,
    disabled: true,
    ghostClass: "sortable-ghost",
    chosenClass: "sortable-chosen",
    onEnd: function (evt) {
      const items = listElement.querySelectorAll("li");
      items.forEach((li, index) => {
        const id = li.getAttribute("data-id");
        listRef.child(id).update({ order: index });
      });
    }
  });

  // âœ… é•·æŠ¼ã—ã§ä¸¦ã³æ›¿ãˆæœ‰åŠ¹ã€è¦–è¦šãƒ¢ãƒ¼ãƒ‰ON
  let longPressTimer = null;

  listElement.addEventListener("touchstart", function (e) {
    if (e.target.tagName === "BUTTON") return;

    longPressTimer = setTimeout(() => {
      sortable.option("disabled", false);
      document.body.classList.add("drag-mode"); // ðŸ”¶ ãƒ¢ãƒ¼ãƒ‰ON
    }, 300);
  });

  listElement.addEventListener("touchend", function () {
    clearTimeout(longPressTimer);
    setTimeout(() => {
      sortable.option("disabled", true);
      document.body.classList.remove("drag-mode"); // ðŸ”¶ ãƒ¢ãƒ¼ãƒ‰OFF
    }, 1000);
  });

  listRef.orderByChild("order").on("value", (snapshot) => {
    listElement.innerHTML = "";

    snapshot.forEach((childSnapshot) => {
      const key = childSnapshot.key;
      const data = childSnapshot.val();

      const li = document.createElement("li");
      li.setAttribute("data-id", key);
      li.className = "list-item";

      const content = document.createElement("span");
      content.textContent = data.text;
      content.className = "item-text";
      if (data.checked) content.classList.add("checked");

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "button-group";

      const doneBtn = document.createElement("button");
      doneBtn.textContent = data.checked ? "è³¼å…¥æ¸ˆ" : "æœªè³¼å…¥";
      doneBtn.className = data.checked ? "done purchased" : "done not-purchased";
      doneBtn.onclick = () => {
        listRef.child(key).update({ checked: !data.checked });
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "å‰Šé™¤";
      deleteBtn.className = "delete";
      deleteBtn.onclick = () => listRef.child(key).remove();

      buttonGroup.appendChild(doneBtn);
      buttonGroup.appendChild(deleteBtn);

      li.appendChild(content);
      li.appendChild(buttonGroup);
      listElement.appendChild(li);
    });
  });
</script>





