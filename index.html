<script>
  const db = firebase.database();
  const listRef = db.ref("items");
  const listElement = document.getElementById("list");

  function addItem() {
    const input = document.getElementById("itemInput");
    const value = input.value.trim();
    if (!value) return;
    const newItemRef = listRef.push();
    newItemRef.set({
      text: value,
      checked: false,
      order: Date.now()
    });
    input.value = "";
  }

  document.getElementById("itemInput").addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      addItem();
    }
  });

  const sortable = new Sortable(listElement, {
    animation: 150,
    disabled: true,
    ghostClass: "sortable-ghost",
    chosenClass: "sortable-chosen",

    // ✅ 並び替え後に順番を保存
    onEnd: function () {
      const items = listElement.querySelectorAll("li");
      items.forEach((li, index) => {
        const id = li.getAttribute("data-id");
        listRef.child(id).update({ order: index });
      });
    },

    // ✅ アイテム選択時に個別に強調
    onChoose: function (evt) {
      evt.item.classList.add("highlighted-item");
    },

    onUnchoose: function (evt) {
      evt.item.classList.remove("highlighted-item");
    }
  });

  // ✅ 長押しでドラッグ有効にする（ボタン以外のみ）
  let longPressTimer = null;

  listElement.addEventListener("touchstart", function (e) {
    if (e.target.tagName === "BUTTON") return;

    longPressTimer = setTimeout(() => {
      sortable.option("disabled", false);
    }, 300); // 長押し感知時間
  });

  listElement.addEventListener("touchend", function () {
    clearTimeout(longPressTimer);
    setTimeout(() => {
      sortable.option("disabled", true);
    }, 1000);
  });

  // ✅ Firebaseからリストを表示
  listRef.orderByChild("order").on("value", (snapshot) => {
    listElement.innerHTML = "";

    snapshot.forEach((childSnapshot) => {
      const key = childSnapshot.key;
      const data = childSnapshot.val();

      const li = document.createElement("li");
      li.setAttribute("data-id", key);
      li.className = "list-item";

      const content = document.createElement("span");
      content.textContent = data.text;
      content.className = "item-text";
      if (data.checked) content.classList.add("checked");

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "button-group";

      const doneBtn = document.createElement("button");
      doneBtn.textContent = data.checked ? "購入済" : "未購入";
      doneBtn.className = data.checked ? "done purchased" : "done not-purchased";
      doneBtn.onclick = () => {
        listRef.child(key).update({ checked: !data.checked });
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "削除";
      deleteBtn.className = "delete";
      deleteBtn.onclick = () => listRef.child(key).remove();

      buttonGroup.appendChild(doneBtn);
      buttonGroup.appendChild(deleteBtn);

      li.appendChild(content);
      li.appendChild(buttonGroup);
      listElement.appendChild(li);
    });
  });
</script>
